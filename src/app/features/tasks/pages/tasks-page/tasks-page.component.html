<div class="page-header">
  <h2 class="page-title">Tareas</h2>
  <span class="spacer"></span>

  <button mat-raised-button color="primary" (click)="openCreate()">
    Nueva tarea
  </button>
</div>

<div
  class="filters"
  [class.admin]="isAdmin()"
  [class.not-admin]="!isAdmin()"
  [formGroup]="filterForm"
>
  <mat-form-field appearance="outline">
    <mat-label>Buscar por nombre</mat-label>
    <input matInput formControlName="name" placeholder="Ej: reportes" />
  </mat-form-field>

  <mat-form-field appearance="outline">
    <mat-label>Estado</mat-label>
    <mat-select formControlName="status">
      @for (s of statuses; track s.value) {
        <mat-option [value]="s.value">
          {{ s.label }}
        </mat-option>
      }
    </mat-select>
  </mat-form-field>

  @if (isAdmin()) {
    <mat-form-field appearance="outline">
      <mat-label>Usuario</mat-label>
      <mat-select formControlName="userId">
        <mat-option [value]="'all'">Todos</mat-option>
        @for (u of adminUsers; track u.id) {
          <mat-option [value]="u.id">
            {{ u.name || u.email }}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>
  }
</div>

<div class="table-card">
  <table mat-table [dataSource]="dataSource" matSort class="table">
    <ng-container matColumnDef="title">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
      <td mat-cell *matCellDef="let t">{{ t.title }}</td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
      <td mat-cell *matCellDef="let t">
        <span class="pill" [ngClass]="'pill--' + t.status">
          {{
            t.status === 'pending' ? 'Pendiente' : t.status === 'in_progress' ? 'En Progreso' : 'Completada'
          }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="userId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Asignado a</th>
      <td mat-cell *matCellDef="let t">{{ userLabel(t.userId) }}</td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef class="actions-head">Acciones</th>
      <td mat-cell *matCellDef="let t">
        <div class="actions">
          <button mat-icon-button (click)="openEdit(t)" aria-label="edit">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button (click)="delete(t)" aria-label="delete">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>

  <mat-paginator [pageSize]="5" [pageSizeOptions]="[5, 10, 20]"></mat-paginator>
</div>
